var d=6e4,h=[],m=[],u,s,a,c,y=0,f=0,E=({type:e="",message:r="",progress:t=0,timeElapsed:o=0})=>{},b=({raw_intensity:e=[],ppg_time:r=[],average_fps:t=0})=>{},p=(e=new Error("Fingerscan Error."))=>{},v=()=>new Promise(async(e,r)=>{var t,o,n;try{let i=/iPhone|iPad|iPod|Macintosh|Mac/i.test(navigator.userAgent),l=await navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment",aspectRatio:{ideal:16/9},frameRate:{ideal:60},height:i?{exact:720}:{ideal:480}}});(n=(o=(t=l.getVideoTracks())==null?void 0:t[0])==null?void 0:o.applyConstraints)==null||n.call(o,{advanced:[{torch:!0}]}).catch(g=>console.error(new Error("Flash could not be acquired.",{cause:g}))),s.srcObject=l,s.onloadedmetadata=async()=>{var g;await((g=s.play)==null?void 0:g.call(s)),e()}}catch(i){r(new Error("We are not able to access the Camera. Please try again.",{cause:i}))}}),w=()=>{var e,r,t,o;cancelAnimationFrame(y),(o=(t=(r=(e=s==null?void 0:s.srcObject)==null?void 0:e.getTracks)==null?void 0:r.call(e))==null?void 0:t.forEach)==null||o.call(t,n=>{var i;(i=n==null?void 0:n.stop)==null||i.call(n)}),window.onblur=void 0,u==null||u.release().then(()=>{console.log("WakeLock Released.")}).catch(n=>{console.log("WakeLock Error."),console.error(n)})},M=({r:e=0,g:r=0,b:t=0})=>{if(e<25||e<r||e<t)return 0;let o=r+t;return o<=20?1:o>150?0:Math.min(Math.max((232.7-Math.sqrt((255-e)**2+r**2+t**2))/217.84,0),1)},_=e=>{let r=0,t={r:0,g:0,b:0};for(let o=0;o<e.data.length;o+=4){let n=e.data[o],i=e.data[o+1],l=e.data[o+2];n===0&&i===0&&l===0||(r++,t.r+=n,t.g+=i,t.b+=l)}return{r:t.r/r,g:t.g/r,b:t.b/r}},C=(e="Fingerscan Error Hint.")=>{E({type:"error",message:e,progress:0,timeElapsed:0}),h=[],m=[],f=performance.now(),y=requestAnimationFrame(F)},F=(e=0)=>{let r=e-f;try{c.save(),c.clearRect(0,0,a.width,a.height),c.drawImage(s,0,0,a.width,a.height);let t=_(c.getImageData(a.width/5,a.height/5,a.width*.6,a.height*.6));if(c.restore(),M(t)>.625)if(h.push(t),m.push(performance.now()-f),E({type:r<=3e3?"calibration":"scan",message:r<=3e3?"Starting in ".concat(Math.min(4-Math.round(r/1e3),3)):"".concat(Math.round((r-3e3)/(d-3e3)*100),"% Completed"),progress:Math.round(r/d*100),timeElapsed:r}),r<=d)y=requestAnimationFrame(F);else{w();let n=Math.round(h.length*1e3/d);n<10?p(new Error("Sorry, Finger Scan is not supported on this device.")):b({raw_intensity:h,ppg_time:m,average_fps:n})}else C("Finger not detected.")}catch(t){w(),p(new Error("Sorry we're unable to compute the signal. Please try again.",{cause:t}))}},S=async({scanDuration:e=60,videoElement:r,canvasElement:t})=>{var o;h=[],m=[];try{if(typeof e!="number"||e<10||e>120||e%5!==0)throw new Error("Scan duration can be between 10-120 seconds (multiple of 5).");if(d=(e+3)*1e3,s=typeof r>"u"?document.getElementById("videoInput"):r,s)await v();else throw new Error("Cannot access the video element.");if(a=typeof t>"u"?document.getElementById("canvasOutput"):t,a)a.width=s.videoWidth,a.height=s.videoHeight,c=a.getContext("2d",{alpha:!1,willReadFrequently:!0});else throw new Error("Cannot access the canvas element.");(o=navigator.wakeLock)==null||o.request("screen").then(n=>{u=n,console.log("WakeLock Active.")}).catch(n=>{console.log("WakeLock Error."),console.error(n)}),window.onblur=()=>{w(),p(new Error("App functionality disabled in the Background. Keep it in the Foreground for proper operation."))},f=performance.now(),y=requestAnimationFrame(F)}catch(n){throw w(),p(n),new Error("Fingerscan Initialization Error.",{cause:n})}};var q=(e=({type:r="",message:t="",progress:o=0,timeElapsed:n=0})=>{})=>{typeof e=="function"&&(E=e)},I=(e=({raw_intensity:r=[],ppg_time:t=[],average_fps:o=0})=>{})=>{typeof e=="function"&&(b=e)},x=(e=(r=new Error("Fingerscan Error."))=>{})=>{typeof e=="function"&&(p=e)};export{x as onError,q as onFrame,I as onScanFinish,S as startScan,w as stopScan};
