var d=6e4,p=[],u=[],g,s,a,l,w=0,m=0,y=({type:e="",message:r="",progress:t=0,timeElapsed:o=0})=>{},F=({raw_intensity:e=[],ppg_time:r=[],average_fps:t=0})=>{},h=(e=new Error("Fingerscan Error."))=>{},b=()=>new Promise(async(e,r)=>{var t,o,n;try{let i=await navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment",aspectRatio:{ideal:1.7777777777777777},frameRate:{ideal:60},height:{ideal:480}}});(n=(o=(t=i.getVideoTracks())==null?void 0:t[0])==null?void 0:o.applyConstraints)==null||n.call(o,{advanced:[{torch:!0}]}).catch(c=>console.error(new Error("Flash could not be acquired.",{cause:c}))),s.srcObject=i,s.onloadedmetadata=async()=>{var c;await((c=s.play)==null?void 0:c.call(s)),e()}}catch(i){r(new Error("We are not able to access the Camera. Please try again.",{cause:i}))}}),f=()=>{var e,r,t,o;cancelAnimationFrame(w),(o=(t=(r=(e=s==null?void 0:s.srcObject)==null?void 0:e.getTracks)==null?void 0:r.call(e))==null?void 0:t.forEach)==null||o.call(t,n=>{var i;(i=n==null?void 0:n.stop)==null||i.call(n)}),window.onblur=void 0,g==null||g.release().then(()=>{console.log("WakeLock Released.")}).catch(n=>{console.log("WakeLock Error."),console.error(n)})},v=({r:e=0,g:r=0,b:t=0})=>{if(e<25||e<r||e<t)return 0;let o=r+t;return o<=20?1:o>150?0:Math.min(Math.max((232.7-Math.sqrt((255-e)**2+r**2+t**2))/217.84,0),1)},_=e=>{let r=0,t={r:0,g:0,b:0};for(let o=0;o<e.data.length;o+=4){let n=e.data[o],i=e.data[o+1],c=e.data[o+2];n===0&&i===0&&c===0||(r++,t.r+=n,t.g+=i,t.b+=c)}return{r:t.r/r,g:t.g/r,b:t.b/r}},C=(e="Fingerscan Error Hint.")=>{y({type:"error",message:e,progress:0,timeElapsed:0}),p=[],u=[],m=performance.now(),w=requestAnimationFrame(E)},E=(e=0)=>{let r=e-m;try{l.save(),l.clearRect(0,0,a.width,a.height),l.drawImage(s,0,0,a.width,a.height);let t=_(l.getImageData(a.width/5,a.height/5,a.width*.6,a.height*.6));if(l.restore(),v(t)>.625)if(p.push(t),u.push(performance.now()-m),y({type:r<=3e3?"calibration":"scan",message:r<=3e3?"Starting in ".concat(Math.min(4-Math.round(r/1e3),3)):"".concat(Math.round((r-3e3)/(d-3e3)*100),"% Completed"),progress:Math.round(r/d*100),timeElapsed:r}),r<=d)w=requestAnimationFrame(E);else{f();let n=Math.round(p.length*1e3/d);n<10?h(new Error("Sorry, Finger Scan is not supported on this device.")):F({raw_intensity:p,ppg_time:u,average_fps:n})}else C("Finger not detected.")}catch(t){f(),h(new Error("Sorry we're unable to compute the signal. Please try again.",{cause:t}))}},M=async({scanDuration:e=60,videoElement:r,canvasElement:t})=>{var o;p=[],u=[];try{if(typeof e!="number"||e<10||e>120||e%5!==0)throw new Error("Scan duration can be between 10-120 seconds (multiple of 5).");if(d=(e+3)*1e3,s=typeof r>"u"?document.getElementById("videoInput"):r,s)await b();else throw new Error("Cannot access the video element.");if(a=typeof t>"u"?document.getElementById("canvasOutput"):t,a)a.width=s.videoWidth,a.height=s.videoHeight,l=a.getContext("2d",{alpha:!1,willReadFrequently:!0});else throw new Error("Cannot access the canvas element.");(o=navigator.wakeLock)==null||o.request("screen").then(n=>{g=n,console.log("WakeLock Active.")}).catch(n=>{console.log("WakeLock Error."),console.error(n)}),window.onblur=()=>{f(),h(new Error("App functionality disabled in the Background. Keep it in the Foreground for proper operation."))},m=performance.now(),w=requestAnimationFrame(E)}catch(n){throw f(),h(n),new Error("Fingerscan Initialization Error.",{cause:n})}};var q=(e=({type:r="",message:t="",progress:o=0,timeElapsed:n=0})=>{})=>{typeof e=="function"&&(y=e)},S=(e=({raw_intensity:r=[],ppg_time:t=[],average_fps:o=0})=>{})=>{typeof e=="function"&&(F=e)},I=(e=(r=new Error("Fingerscan Error."))=>{})=>{typeof e=="function"&&(h=e)};export{I as onError,q as onFrame,S as onScanFinish,M as startScan,f as stopScan};
